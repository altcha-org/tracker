(function(n,s){typeof exports=="object"&&typeof module<"u"?s(exports):typeof define=="function"&&define.amd?define(["exports"],s):(n=typeof globalThis<"u"?globalThis:n||self,s(n.AltchaAnalyticsTracker={}))})(this,function(n){"use strict";var j=Object.defineProperty;var O=n=>{throw TypeError(n)};var F=(n,s,r)=>s in n?j(n,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):n[s]=r;var a=(n,s,r)=>F(n,typeof s!="symbol"?s+"":s,r),M=(n,s,r)=>s.has(n)||O("Cannot "+r);var o=(n,s,r)=>(M(n,s,"read from private field"),r?r.call(n):s.get(n)),h=(n,s,r)=>s.has(n)?O("Cannot add the same private member more than once"):s instanceof WeakSet?s.add(n):s.set(n,r),v=(n,s,r,N)=>(M(n,s,"write to private field"),N?N.call(n,r):s.set(n,r),r),R=(n,s,r)=>(M(n,s,"access private method"),r);var p,g,m,b,y,k,x,P,f,w,T,L,S,E,d,A,D;class s{constructor(i,t={disable:!1}){a(this,"lastEvent",null);this.tracker=i,this.options=t}destroy(){}getExitReason(i=!1){}isLastEventRecent(i=1e4,t=this.lastEvent){return!!t&&performance.now()-t.timeStamp<i}}class r extends s{constructor(t,e){super(t);h(this,p,this.onClick.bind(this));addEventListener("click",o(this,p),{capture:!0})}destroy(){removeEventListener("click",o(this,p))}getExitReason(){if(this.lastEvent&&this.isLastEventRecent()){const t=this.lastEvent.target,e=(t==null?void 0:t.getAttribute("data-link"))||(t==null?void 0:t.getAttribute("href"));if(e){const l=new URL(e,location.origin);if(l.hostname&&l.hostname!==location.hostname)return this.tracker.sanitizeUrl(l)}}}onClick(t){const e=t.target;e&&e.tagName==="A"&&(this.lastEvent=t)}}p=new WeakMap;class N extends s{constructor(t,e){super(t);h(this,g);h(this,m);h(this,b);v(this,g,e.cookieName||"_altcha_visited"),v(this,m,e.cookieExpireDays||30),v(this,b,e.cookiePath||"/"),this.getCookie(o(this,g))==="1"&&(this.tracker.returningVisitor=!0),this.setCookie(o(this,g),"1",new Date(Date.now()+864e5*o(this,m)))}destroy(){}getCookie(t){const e=document.cookie.split(/;\s?/);for(const l of e)if(l.startsWith(t+"="))return l.slice(t.length+1);return null}setCookie(t,e,l){document.cookie=t+"="+e+"; expires="+l.toUTCString()+`; SameSite=Strict; path=${o(this,b)||"/"}`}}g=new WeakMap,m=new WeakMap,b=new WeakMap;class U extends s{constructor(t,e){super(t);h(this,y,this.onHashChange.bind(this));addEventListener("hashchange",o(this,y))}destroy(){removeEventListener("hashchange",o(this,y))}onHashChange(){this.tracker.trackPageview()}}y=new WeakMap;class _ extends s{constructor(t,e){super(t);h(this,k,this.onKeyDown.bind(this));addEventListener("keydown",o(this,k))}destroy(){removeEventListener("keydown",o(this,k))}isLastKeyboardEventCtrl(){return!!this.lastEvent&&(this.lastEvent.ctrlKey||this.lastEvent.metaKey)}getExitReason(t=!1){if(t&&this.isLastEventRecent(100)&&this.isLastKeyboardEventCtrl())return""}onKeyDown(t){this.lastEvent=t}}k=new WeakMap;class I extends s{constructor(t,e){super(t);h(this,x,this.onMouseEnter.bind(this));h(this,P,this.onMouseLeave.bind(this));a(this,"isMouseOut",!1);a(this,"offsetX",-1);a(this,"offsetY",-1);document.body.addEventListener("mouseleave",o(this,P)),document.body.addEventListener("mouseenter",o(this,x))}destroy(){document.body.removeEventListener("mouseleave",o(this,P)),document.body.removeEventListener("mouseenter",o(this,x))}getExitReason(){if(this.isMouseOut){const t=this.tracker.getExtension("pushstate");return t&&t.lastPopStateEvent&&t.isLastEventRecent(100,t.lastPopStateEvent)||this.offsetX>=0&&this.offsetX>=0&&this.offsetX<150?void 0:""}}onMouseEnter(){this.isMouseOut=!1,this.offsetX=-1,this.offsetY=-1}onMouseLeave(t){this.isMouseOut=!0,this.offsetX=t.clientX,this.offsetY=t.clientY}}x=new WeakMap,P=new WeakMap;class V extends s{constructor(t,e){super(t);h(this,f,null);h(this,w,this.onPopState.bind(this));h(this,T,this.onPushState.bind(this));a(this,"lastPopStateEvent",null);const l=v(this,f,history.pushState);history.pushState=(H,B,K)=>{o(this,T).call(this),l==null||l.apply(history,[H,B,K])},addEventListener("popstate",o(this,w))}destroy(){o(this,f)&&(history.pushState=o(this,f)),removeEventListener("popstate",o(this,w))}onPopState(t){this.lastPopStateEvent=t,this.tracker.trackPageview()}onPushState(){this.tracker.trackPageview()}}f=new WeakMap,w=new WeakMap,T=new WeakMap;class X extends s{constructor(t,e){super(t);h(this,L,this.onVisibilityChange.bind(this));h(this,S);h(this,E,null);a(this,"visibilityState",document.visibilityState);v(this,S,e.hiddenTimeout||4e3),addEventListener("visibilitychange",o(this,L))}destroy(){removeEventListener("visibilitychange",o(this,L))}getExitReason(t=!1){if(t&&this.visibilityState==="hidden"&&this.lastEvent&&performance.now()-this.lastEvent.timeStamp>=1e3)return""}onTimeout(){document.visibilityState==="hidden"&&this.tracker.trackPageview({},!0)}onVisibilityChange(t){this.lastEvent=t,this.visibilityState=document.visibilityState,this.tracker.isMobile&&(o(this,E)&&clearTimeout(o(this,E)),document.visibilityState==="hidden"&&v(this,E,setTimeout(()=>{this.onTimeout()},o(this,S))))}}L=new WeakMap,S=new WeakMap,E=new WeakMap;const c=class c{constructor(i){h(this,A);h(this,d,this.onPageHide.bind(this));a(this,"isMobile",/Mobi|Android|iPhone|iPad|iPod|Opera Mini/i.test(navigator.userAgent||""));a(this,"events",[]);a(this,"extensions",{});a(this,"globalName",null);a(this,"lastPageLoadAt",performance.now());a(this,"lastPageview",null);a(this,"returningVisitor",null);a(this,"trackedEvents",0);a(this,"trackedPageviews",0);if(this.options=i,!i.projectId)throw new Error("Parameter projectId required.");R(this,A,D).call(this),this.isDNTEnabled&&this.options.respectDnt===!0?this.log("DoNotTrack enabled."):(this.loadExtensions(),addEventListener("pagehide",o(this,d)),addEventListener("beforeunload",o(this,d)))}get apiUrl(){return this.options.apiUrl||c.DEFAULT_API_URL}get isDNTEnabled(){return"doNotTrack"in navigator&&navigator.doNotTrack==="1"||"globalPrivacyControl"in navigator&&navigator.globalPrivacyControl===!0}destroy(){this.flushEvents();for(const i in this.extensions)this.extensions[i].destroy();this.extensions={},removeEventListener("pagehide",o(this,d)),removeEventListener("beforeunload",o(this,d)),this.globalName&&delete globalThis[this.globalName]}flushEvents(){const i=this.events.splice(0);i.length&&this.sendBeacon(i)}getBeaconPayload(i){return{events:i,projectId:this.options.projectId,time:Date.now(),uniqueId:this.options.uniqueId}}getExitReason(i=!1){for(const t in this.extensions){const e=this.extensions[t].getExitReason(i);if(e!==void 0)return this.log("exit reason:",{ext:t,result:e}),e}}getExtension(i){return this.extensions[i]}getHostname(){return location.hostname}getOrigin(){return location.origin}getView(){return this.sanitizeUrl(location.href)}getPageviewOptions(i=!1){const t=this.getExitReason(i),e=this.getReferrer(),l=this.getOrigin();return{appVersion:this.options.appVersion,exit:t!==void 0,outbound:t,duration:Math.max(0,Math.floor(performance.now()-this.lastPageLoadAt)),referrer:e&&new URL(e,l).origin===l?"":e,returning:this.returningVisitor===null?void 0:this.returningVisitor,view:this.getView()}}getReferrer(){return document.referrer}hasExtension(i){return!!this.getExtension(i)}loadExtensions(){var i;for(const t in c.EXTENSIONS){let e=((i=this.options)==null?void 0:i[t])!==void 0?this.options[t]:{};typeof e=="boolean"?e={disable:!e}:e.disable=e.disable===void 0?!c.DEFAULT_EXTENSIONS.includes(t):e.disable,e.disable!==!0&&(this.extensions[t]=new c.EXTENSIONS[t](this,e))}}log(...i){this.options.debug&&console.log("[ALTCHA Tracker]",...i)}sanitizeUrl(i){var t;if(i=new URL(i),(t=this.options.allowSearchParams)!=null&&t.length&&i.hostname===this.getHostname())for(const[e]of i.searchParams)this.options.allowSearchParams.includes(e)||i.searchParams.delete(e);else i.search="";return this.hasExtension("hash")||(i.hash=""),i.toString()}sendBeacon(i){if("sendBeacon"in navigator)return navigator.sendBeacon(this.apiUrl,JSON.stringify(this.getBeaconPayload(i)))}trackEvent(i={},t=!1){const e={timestamp:Date.now(),...i};return this.events.push(e),this.trackedEvents+=1,this.log("trackEvent",e),t&&this.flushEvents(),!0}trackPageview(i={},t=!1){const e=this.getPageviewOptions(t);return this.events.length&&e.duration<100&&this.events[this.events.length-1].view===e.view?(this.log("duplicate pageview",e),!1):(this.log("trackPageview",e),this.trackEvent({...e,...i},t),this.trackedPageviews+=1,this.lastPageLoadAt=performance.now(),this.lastPageview=e.view,e.exit&&(this.trackedPageviews=0),!0)}onPageHide(){this.lastPageview!==this.getView()&&this.trackPageview({},!0)}};d=new WeakMap,A=new WeakSet,D=function(){if(this.globalName=this.options.globalName===void 0?c.DEAFAUL_GLOBAL_NAME:this.options.globalName||null,this.globalName){if(globalThis[this.globalName])throw new Error("Another instance of the Tracker is already present in globalThis. Set globalName:null to disable global reference.");globalThis[this.globalName]=this}},a(c,"EXTENSIONS",{click:r,cookie:N,hash:U,keyboard:_,mouse:I,pushstate:V,visibility:X}),a(c,"DEFAULT_API_URL","https://eu.altcha.org/api/v1/event"),a(c,"DEFAULT_EXTENSIONS",["click","keyboard","mouse","pushstate","visibility"]),a(c,"DEAFAUL_GLOBAL_NAME","altchaTracker");let C=c;n.Tracker=C,Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});
