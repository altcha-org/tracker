(function(o,s){typeof exports=="object"&&typeof module<"u"?s(exports):typeof define=="function"&&define.amd?define(["exports"],s):(o=typeof globalThis<"u"?globalThis:o||self,s(o.AltchaAnalyticsTracker={}))})(this,function(o){"use strict";var Z=Object.defineProperty;var V=o=>{throw TypeError(o)};var tt=(o,s,h)=>s in o?Z(o,s,{enumerable:!0,configurable:!0,writable:!0,value:h}):o[s]=h;var r=(o,s,h)=>tt(o,typeof s!="symbol"?s+"":s,h),H=(o,s,h)=>s.has(o)||V("Cannot "+h);var n=(o,s,h)=>(H(o,s,"read from private field"),h?h.call(o):s.get(o)),l=(o,s,h)=>s.has(o)?V("Cannot add the same private member more than once"):s instanceof WeakSet?s.add(o):s.set(o,h),v=(o,s,h,C)=>(H(o,s,"write to private field"),C?C.call(o,h):s.set(o,h),h),G=(o,s,h)=>(H(o,s,"access private method"),h);var b,p,k,y,x,w,L,P,S,A,E,T,O,N,R,m,f,_,K,X,B;class s{constructor(i,t={disable:!1}){r(this,"lastEvent",null);this.tracker=i,this.options=t}destroy(){}getExitReason(i=!1){}isLastEventRecent(i=1e4,t=this.lastEvent){return!!t&&performance.now()-t.timeStamp<i}shouldTrackEvent(i){return!0}}class h extends s{constructor(t,e){super(t);l(this,b,this.onClick.bind(this));addEventListener("click",n(this,b),{capture:!0})}destroy(){removeEventListener("click",n(this,b))}getExitReason(){if(this.lastEvent&&this.isLastEventRecent()){const t=this.lastEvent.target,e=(t==null?void 0:t.getAttribute("data-link"))||(t==null?void 0:t.getAttribute("href"));if(e){const a=new URL(e,location.origin);if(a.hostname&&a.hostname!==location.hostname)return this.tracker.sanitizeUrl(a)}}}onClick(t){const e=t.target;e&&e.tagName==="A"&&(this.lastEvent=t)}}b=new WeakMap;class C extends s{constructor(t,e){super(t);l(this,p);l(this,k);l(this,y);v(this,p,e.cookieName||"_altcha_visited"),v(this,k,e.cookieExpireDays||30),v(this,y,e.cookiePath||"/"),this.getCookie(n(this,p))==="1"&&(this.tracker.returningVisitor=!0),this.setCookie(n(this,p),"1",new Date(Date.now()+864e5*n(this,k)))}destroy(){}getCookie(t){const e=document.cookie.split(/;\s?/);for(const a of e)if(a.startsWith(t+"="))return a.slice(t.length+1);return null}setCookie(t,e,a){document.cookie=t+"="+e+"; expires="+a.toUTCString()+`; SameSite=Strict; path=${n(this,y)||"/"}`}}p=new WeakMap,k=new WeakMap,y=new WeakMap;const g=class g extends s{constructor(t,e){super(t);l(this,x);l(this,w,!1);this.options=e,v(this,w,localStorage.getItem(g.LOCAL_STORAGE_KEY)==="true"),v(this,x,(e.hostnames||g.DEFAULT_HOSTNAMES).map(a=>a.includes("*")?new RegExp(a.replace(/\*/g,"[^.]+")):a))}checkFn(t){if(this.options.checkFn)return this.options.checkFn(t)}destroy(){}isBot(){return g.CRAWLER_REG_EXP.test(this.tracker.getUserAgent())}isPrivateHostname(){const t=this.tracker.getHostname();return n(this,x).some(e=>e instanceof RegExp&&e.test(t)?!0:t===e)}shouldTrackEvent(t){if(n(this,w))return this.tracker.log(`ignoring event: ${g.LOCAL_STORAGE_KEY}`),!1;const e=this.checkFn(t);return e!==void 0?e:this.isPrivateHostname()?(this.tracker.log("ignoring event: private hostname"),!1):this.options.allowBots!==!0&&this.isBot()?(this.tracker.log("ignoring event: bot"),!1):!0}};x=new WeakMap,w=new WeakMap,r(g,"CRAWLER_REG_EXP",/(?:bot|spider|crawler|facebookexternalhit|simplepie|yahooseeker|embedly|quora link preview|outbrain|vkshare|monit|Pingability|Monitoring|WinHttpRequest|Apache-HttpClient|getprismatic.com|python-requests|Twurly|yandex|browserproxy|Qwantify|Yahoo! Slurp|pinterest|Tumblr|WhatsApp|Google-Structured-Data-Testing-Tool|Google-InspectionTool|GPTBot|Applebot)/i),r(g,"DEFAULT_HOSTNAMES",["127.0.0.1","localhost","*.local"]),r(g,"LOCAL_STORAGE_KEY","altcha_ignore");let U=g;class F extends s{constructor(t,e){super(t);l(this,L,this.onHashChange.bind(this));addEventListener("hashchange",n(this,L))}destroy(){removeEventListener("hashchange",n(this,L))}onHashChange(){this.tracker.trackPageview()}}L=new WeakMap;class Y extends s{constructor(t,e){super(t);l(this,P,this.onKeyDown.bind(this));addEventListener("keydown",n(this,P))}destroy(){removeEventListener("keydown",n(this,P))}isLastKeyboardEventCtrl(){return!!this.lastEvent&&(this.lastEvent.ctrlKey||this.lastEvent.metaKey)}getExitReason(t=!1){if(t&&this.isLastEventRecent(100)&&this.isLastKeyboardEventCtrl())return""}onKeyDown(t){this.lastEvent=t}}P=new WeakMap;class j extends s{constructor(t,e){super(t);l(this,S,this.onMouseEnter.bind(this));l(this,A,this.onMouseLeave.bind(this));r(this,"isMouseOut",!1);r(this,"offsetX",-1);r(this,"offsetY",-1);document.body.addEventListener("mouseleave",n(this,A)),document.body.addEventListener("mouseenter",n(this,S))}destroy(){document.body.removeEventListener("mouseleave",n(this,A)),document.body.removeEventListener("mouseenter",n(this,S))}getExitReason(){if(this.isMouseOut){const t=this.tracker.getExtension("pushstate");return t&&t.lastPopStateEvent&&t.isLastEventRecent(100,t.lastPopStateEvent)||this.offsetX>=0&&this.offsetX>=0&&this.offsetX<150?void 0:""}}onMouseEnter(){this.isMouseOut=!1,this.offsetX=-1,this.offsetY=-1}onMouseLeave(t){this.isMouseOut=!0,this.offsetX=t.clientX,this.offsetY=t.clientY}}S=new WeakMap,A=new WeakMap;class q extends s{constructor(t,e){super(t);l(this,E,null);l(this,T,this.onPopState.bind(this));l(this,O,this.onPushState.bind(this));r(this,"lastPopStateEvent",null);const a=v(this,E,history.pushState);history.pushState=(D,J,Q)=>{n(this,O).call(this),a==null||a.apply(history,[D,J,Q])},addEventListener("popstate",n(this,T))}destroy(){n(this,E)&&(history.pushState=n(this,E)),removeEventListener("popstate",n(this,T))}onPopState(t){this.lastPopStateEvent=t,this.tracker.trackPageview()}onPushState(){this.tracker.trackPageview()}}E=new WeakMap,T=new WeakMap,O=new WeakMap;class W extends s{constructor(t,e){super(t);l(this,N,this.onVisibilityChange.bind(this));l(this,R);l(this,m,null);r(this,"visibilityState",document.visibilityState);v(this,R,e.hiddenTimeout||4e3),addEventListener("visibilitychange",n(this,N))}destroy(){removeEventListener("visibilitychange",n(this,N))}getExitReason(t=!1){if(t&&this.visibilityState==="hidden"&&this.lastEvent&&performance.now()-this.lastEvent.timeStamp>=1e3)return""}onTimeout(){document.visibilityState==="hidden"&&this.tracker.trackPageview({},!0)}onVisibilityChange(t){this.lastEvent=t,this.visibilityState=document.visibilityState,this.tracker.isMobile&&(n(this,m)&&clearTimeout(n(this,m)),document.visibilityState==="hidden"&&v(this,m,setTimeout(()=>{this.onTimeout()},n(this,R))))}}N=new WeakMap,R=new WeakMap,m=new WeakMap;const c=class c{constructor(i){l(this,_);l(this,f,this.onPageHide.bind(this));r(this,"isMobile",/Mobi|Android|iPhone|iPad|iPod|Opera Mini/i.test(this.getUserAgent()));r(this,"events",[]);r(this,"extensions",{});r(this,"globalName",null);r(this,"lastPageLoadAt",performance.now());r(this,"lastPageview",null);r(this,"returningVisitor",null);r(this,"trackedEvents",0);r(this,"trackedPageviews",0);if(this.options=i,!i.projectId)throw new Error("Parameter projectId required.");G(this,_,K).call(this),this.isDNTEnabled&&this.options.respectDnt===!0?this.log("DoNotTrack enabled."):(this.loadExtensions(),addEventListener("pagehide",n(this,f)),addEventListener("beforeunload",n(this,f)))}get apiUrl(){return this.options.apiUrl||c.DEFAULT_API_URL}get isDNTEnabled(){return"doNotTrack"in navigator&&navigator.doNotTrack==="1"||"globalPrivacyControl"in navigator&&navigator.globalPrivacyControl===!0}destroy(){this.flushEvents();for(const i in this.extensions)this.extensions[i].destroy();this.extensions={},removeEventListener("pagehide",n(this,f)),removeEventListener("beforeunload",n(this,f)),this.globalName&&delete globalThis[this.globalName]}flushEvents(){const i=this.events.splice(0);i.length&&this.sendBeacon(i)}getBeaconPayload(i){return{events:i,projectId:this.options.projectId,time:Date.now(),uniqueId:this.options.uniqueId}}getExitReason(i=!1){for(const t in this.extensions){const e=this.extensions[t].getExitReason(i);if(e!==void 0)return this.log("exit reason:",{ext:t,result:e}),e}}getExtension(i){return this.extensions[i]}getHostname(){return location.hostname}getOrigin(){return location.origin}getUserAgent(){return navigator.userAgent||""}getView(){return this.sanitizeUrl(location.href)}getPageviewOptions(i=!1){const t=this.getExitReason(i),e=this.getReferrer(),a=this.getOrigin();return{appVersion:this.options.appVersion,exit:t!==void 0,outbound:t,duration:Math.max(0,Math.floor(performance.now()-this.lastPageLoadAt)),referrer:e&&new URL(e,a).origin===a?"":e,returning:this.returningVisitor===null?void 0:this.returningVisitor,view:this.getView()}}getReferrer(){return document.referrer}hasExtension(i){return!!this.getExtension(i)}loadExtensions(){var i;for(const t in c.EXTENSIONS){let e=((i=this.options)==null?void 0:i[t])!==void 0?this.options[t]:{};typeof e=="boolean"?e={disable:!e}:e.disable=e.disable===void 0?!c.DEFAULT_EXTENSIONS.includes(t):e.disable,e.disable!==!0&&(this.extensions[t]=new c.EXTENSIONS[t](this,e))}}log(...i){this.options.debug&&console.log("[ALTCHA Tracker]",...i)}sanitizeUrl(i){var t;if(i=new URL(i),(t=this.options.allowSearchParams)!=null&&t.length&&i.hostname===this.getHostname())for(const[e]of i.searchParams)this.options.allowSearchParams.includes(e)||i.searchParams.delete(e);else i.search="";return this.hasExtension("hash")||(i.hash=""),i.toString()}sendBeacon(i){if("sendBeacon"in navigator)return navigator.sendBeacon(this.apiUrl,JSON.stringify(this.getBeaconPayload(i)))}shouldTrackEvent(i){for(const t in this.extensions)if(this.extensions[t].shouldTrackEvent(i)!==!0)return this.log("should not track event:",{ext:t,event:i}),!1;return!0}trackEvent(i={},t=!1){const e={timestamp:Date.now(),...i};return this.shouldTrackEvent(e)?(this.events.push(e),this.trackedEvents+=1,this.log("trackEvent",e),t&&this.flushEvents(),!0):!1}trackPageview(i={},t=!1){const e=this.getPageviewOptions(t);return this.events.length&&e.duration<100&&this.events[this.events.length-1].view===e.view?(this.log("duplicate pageview",e),!1):(this.log("trackPageview",e),this.trackEvent({...e,...i},t),this.trackedPageviews+=1,this.lastPageLoadAt=performance.now(),this.lastPageview=e.view,e.exit&&(this.trackedPageviews=0),!0)}onPageHide(){this.lastPageview!==this.getView()&&this.trackPageview({},!0)}};f=new WeakMap,_=new WeakSet,K=function(){if(this.globalName=this.options.globalName===void 0?c.DEAFAUL_GLOBAL_NAME:this.options.globalName||null,this.globalName){if(globalThis[this.globalName])throw new Error("Another instance of the Tracker is already present in globalThis. Set globalName:null to disable global reference.");globalThis[this.globalName]=this}},r(c,"EXTENSIONS",{click:h,cookie:C,filter:U,hash:F,keyboard:Y,mouse:j,pushstate:q,visibility:W}),r(c,"DEFAULT_API_URL","https://eu.altcha.org/api/v1/event"),r(c,"DEFAULT_EXTENSIONS",["click","filter","keyboard","mouse","pushstate","visibility"]),r(c,"DEAFAUL_GLOBAL_NAME","altchaTracker");let M=c;const d=document.currentScript,I=(B=(X=d==null?void 0:d.getAttribute("src"))==null?void 0:X.match(/([\w\-]+)\.altcha\.org/))==null?void 0:B[1],z=((d==null?void 0:d.getAttributeNames())||[]).reduce((u,i)=>{if(i.startsWith("data-")){const t=i.slice(5).replace(/\-([a-z])/g,(a,D)=>D.toUpperCase());let e=d==null?void 0:d.getAttribute(i);e&&(e==="true"?e=!0:e==="false"&&(e=!1),u[t]=e)}return u},{}),$=new M({apiUrl:I?`https://${I}.altcha.org/api/v1/event`:void 0,...z});o.tracker=$,Object.defineProperty(o,Symbol.toStringTag,{value:"Module"})});
